<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"rel="stylesheet"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <style>
      body {
          font-family: 'Jetbrains Mono';
          background-color: rgb(35, 39, 42);
          color: white;
          padding: 0;
          margin: 0;
      }

      #clients {
          display: contents;
      }
      .footer {
    position: fixed;
    bottom: 30px;
    width: 100%;
    align-items: center;
}

      .calldiv {
          z-index: 1000;
          position: absolute;
          left: 50%;
          top: 50%;
          -webkit-transform: translate(-50%, -50%);
          transform: translate(-50%, -50%);
          width: 300px;
          height: 300px;
          background-color: rgb(44, 47, 51);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      #calldivheader {
          cursor: move;
          z-index: 10;
          background-color: rgb(73, 77, 82);
          color: #fff;
      }

      button {
          background-color: rgb(88 101 242);
          color: white;
          font-family: 'JetBrains Mono';
          font-size: larger;
      }

      input {
          font-size: larger;
      }

      p {
          font-size: larger;
      }
    </style>
    <title>Ncord chat</title>
  </head>
  <body>
    <h2 id="ConnectionText" style="color: yellow;">Connecting</h2>
    <p id="dynMsg"></p>
    <p id="id-text"></p>
    <hr>
    <button onclick="ChangeUsername()">Change Username</button>
    <button onclick='window.location.href = "/info"'>Info</button>
    <hr>
    <div class="footer">
    <input type="text" placeholder="Id" id="input-id" />
    <input type="text" placeholder="Message" id="msg-input" />
    <button type="submit" id="send-btn" onclick="Connect()">Send</button>
    </div>
    <div id="msgs"></div>
    <script>
      var username;
      JSON.parse(localStorage.getItem("messages")).msgs.forEach(element => {
          var e = document.createElement("p");
        e.innerHTML = "asdasd"
        e.innerHTML = element;
        
        document.getElementById("msgs").prepend(e);
        });
      if (localStorage.name == null) {
        localStorage.name = rng(1111, 9999);
        username = localStorage.name;
      } else {
        username = localStorage.name;
      }
      var peer = new Peer(username);
      peer.on("open", (p) => {
        document.getElementById("id-text").innerHTML = "Your username: " + peer.id;
        document.getElementById("ConnectionText").innerHTML = "Connected"
        document.getElementById("ConnectionText").style.color = "green"
        
        Notification.requestPermission().then(function (permission) {
    console.log(permission);
});

      });
      function Connect() {
      if(document.getElementById("msg-input").value != ""){
        var conn = peer.connect(document.getElementById("input-id").value);
        // on open will be launch when you successfully connect to PeerServer
        conn.on("open", function () {
          conn.send(
            peer.id + ": " + document.getElementById("msg-input").value
          );
          Print(peer.id + "->" + document.getElementById("input-id").value +": " + document.getElementById("msg-input").value)
          document.getElementById("msg-input").value = "";
        });
      }
      else{
        Print("Error sending last message!")
      }
        
      }
      peer.on("connection", function (conn) {
        conn.on("data", function (data) {
          // Will print 'hi!'
          console.log(data);
          Print(data)
          conn.close();
          if(document.hidden){
          new Notification("New message!",{body:data})
          }
        });
      });
      peer.on("disconnected", function () {
        document.getElementById("ConnectionText").innerHTML = "Disconnected"
        document.getElementById("ConnectionText").style.color = "red"
        peer.reconnect();
      });
      function rng(min, max) {
        // min and max included
        return Math.floor(Math.random() * (max - min + 1) + min);
      }
      function Print(data){
        var e = document.createElement("p");
        e.innerHTML = "asdasd"
        e.innerHTML = data;
        document.getElementById("msgs").prepend(e);
        if(localStorage.getItem("messages") != null){
          var json = JSON.parse(localStorage.getItem("messages"))
          json.msgs.push(data)
          localStorage.setItem("messages",JSON.stringify(json))
        }
        else{
          localStorage.setItem("messages",JSON.stringify({
            "msgs":[]
          }))
          var json = JSON.parse(localStorage.getItem("messages"))
          json.msgs.push(data)
          localStorage.setItem("messages",JSON.stringify(json))
        }
      }
      function ChangeUsername(){
        var name = prompt("Enter your new username")
        if(name !=null){
            localStorage.name = name;
            location.reload()
        }
      }
      const xhr = new XMLHttpRequest();
xhr.open("GET", "https://nazarshuk.github.io/dynamic.txt");
xhr.send();
xhr.responseType = "text";
xhr.onload = () => {
  if (xhr.readyState == 4 && xhr.status == 200) {
    document.getElementById("dynMsg").innerHTML = xhr.response;
  } else {
    console.log(`Error: ${xhr.status}`);
  }
}
      setInterval(function(){
        const xhr = new XMLHttpRequest();
xhr.open("GET", "https://nazarshuk.github.io/dynamic.txt");
xhr.send();
xhr.responseType = "text";
xhr.onload = () => {
  if (xhr.readyState == 4 && xhr.status == 200) {
    document.getElementById("dynMsg").innerHTML = xhr.response;
  } else {
    console.log(`Error: ${xhr.status}`);
  }
};
      },300)
    </script>
  </body>
</html>